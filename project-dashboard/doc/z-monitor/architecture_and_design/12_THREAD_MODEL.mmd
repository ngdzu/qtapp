flowchart TB
  subgraph UIThread[Main / UI Thread - Qt Event Loop]
    UI[QML Views & Controllers<br/>28 components]
  end

  subgraph RTThread[Real-Time Processing Thread - High Priority]
    SensorWS[WebSocketSensorDataSource<br/>ws://localhost:9002]
    DeviceSim[DeviceSimulator<br/>LEGACY fallback]
    MonitorSvc[MonitoringService]
    VCache[VitalsCache<br/>3-day in-memory<br/>~39 MB]
    WCache[WaveformCache<br/>30-sec circular<br/>~0.1 MB]
    PatientAgg[PatientAggregate]
    TelemetryBatch[TelemetryBatch]
    AlarmAgg[AlarmAggregate]
  end

  subgraph AppThread[Application Services - Normal Priority<br/>may co-locate with RT]
    AdmissionSvc[AdmissionService]
    ProvisionSvc[ProvisioningService]
    SecuritySvc[SecurityService]
  end

  subgraph DBThread[Database I/O Thread - Single Writer]
    DBManager[DatabaseManager<br/>+ Schema Management]
    Repos[7 SQLite Repositories<br/>+ VitalsRepository]
    PersistSched[PersistenceScheduler<br/>every 10 min]
    CleanupSvc[DataCleanupService<br/>daily at 3 AM]
    LogSvc[LogService]
    ArchiveSvc[DataArchiveService]
  end

  subgraph NetThread[Network I/O Thread]
    NetTelem[NetworkTelemetryServer]
    HISLookup[HIS/EHR Patient Lookup]
    CentralClient[CentralStationClient]
    CertMgr[CertificateManager]
    EncSvc[EncryptionService]
    SigSvc[SignatureService]
  end

  subgraph BgThread[Background Tasks Thread - Low Priority]
    FirmwareSvc[FirmwareUpdateService]
    BackupSvc[BackupService]
    HealthMon[HealthMonitor]
    ClockSync[ClockSyncService]
    Watchdog[WatchdogService]
    QRGen[QRCodeGenerator]
  end

  SensorWS -->|Qt signals<br/>vitals/waveforms| MonitorSvc
  DeviceSim -->|fallback<br/>if simulator down| MonitorSvc
  MonitorSvc -->|append<br/>CRITICAL < 5ms| VCache
  MonitorSvc -->|append<br/>display only| WCache
  VCache -->|read for<br/>alarm eval| AlarmAgg
  MonitorSvc -->|update state| PatientAgg
  MonitorSvc -->|create batch| TelemetryBatch
  AlarmAgg -->|Qt::QueuedConnection<br/>alarm events| UI
  MonitorSvc -->|Qt::QueuedConnection<br/>vitals updates| UI
  VCache -.->|periodic read<br/>every 10 min| PersistSched
  PersistSched -->|batch INSERT<br/>NON-CRITICAL| Repos
  TelemetryBatch -->|Queue<br/>telemetry submission| NetThread
  CleanupSvc -->|daily DELETE<br/>> 7 days| Repos

  UI -->|Queued calls<br/>admission requests| AdmissionSvc
  UI -->|Queued calls<br/>provisioning| ProvisionSvc
  UI -->|Queued calls<br/>login/auth| SecuritySvc

  AdmissionSvc -->|Repository calls<br/>via queue| DBThread
  ProvisionSvc -->|Repository calls<br/>via queue| DBThread
  SecuritySvc -->|Repository calls<br/>via queue| DBThread

  NetTelem -->|HTTPS/mTLS| ExternalServer[Central Server]
  HISLookup -->|HTTPS| ExternalHIS[HIS/EHR]
  CentralClient -->|HTTPS| ExternalStation[Central Station]

  BgThread -->|Scheduled tasks| DBThread
  Watchdog -->|Monitor heartbeats| RTThread
  Watchdog -->|Monitor heartbeats| DBThread
  Watchdog -->|Monitor heartbeats| NetThread

  classDef uiClass fill:#e1f5ff,stroke:#0288d1,stroke-width:2px
  classDef rtClass fill:#ffccbc,stroke:#d84315,stroke-width:2px
  classDef appClass fill:#c8e6c9,stroke:#388e3c,stroke-width:2px
  classDef dbClass fill:#d1c4e9,stroke:#512da8,stroke-width:2px
  classDef netClass fill:#fff9c4,stroke:#f57f17,stroke-width:2px
  classDef bgClass fill:#b0bec5,stroke:#37474f,stroke-width:2px

  class UIThread uiClass
  class RTThread rtClass
  class AppThread appClass
  class DBThread dbClass
  class NetThread netClass
  class BgThread bgClass
