graph TB
    subgraph AppServicesModule["Application Services Module<br/>(App Services Thread)"]
        subgraph Services["Application Services"]
            AdmissionService[AdmissionService<br/>Admit/discharge/transfer]
            ProvisioningService[ProvisioningService<br/>QR pairing<br/>Certificate install]
            SecurityService[SecurityService<br/>Authentication<br/>RBAC]
            PermissionRegistry[PermissionRegistry<br/>Role â†’ permission mapping]
        end

        subgraph Aggregates["Domain Aggregates"]
            AdmissionAgg[AdmissionAggregate<br/>ADT workflow]
            ProvisioningSession[ProvisioningSession<br/>Pairing workflow]
            UserSession[UserSession<br/>Session management]
            AuditTrail[AuditTrailEntry<br/>Security auditing]
        end

        subgraph ValueObjects["Value Objects"]
            PatientIdentity[PatientIdentity<br/>MRN, Name, DOB]
            BedLocation[BedLocation<br/>Bed/unit/facility]
            PinCredential[PinCredential<br/>Hashed PIN]
            CredentialBundle[CredentialBundle<br/>Certs, keys, URL]
        end
    end

    subgraph ExternalModules["External Modules"]
        InterfaceModule[Interface Module<br/>UI Thread]
        DatabaseModule[Database Module<br/>Database I/O Thread]
        NetworkModule[Network Module<br/>Network I/O Thread]
    end

    %% Service to Aggregate
    AdmissionService -->|Direct Call| AdmissionAgg
    ProvisioningService -->|Direct Call| ProvisioningSession
    SecurityService -->|Direct Call| UserSession
    SecurityService -->|Direct Call| AuditTrail
    SecurityService -->|Reads mapping| PermissionRegistry

    %% Aggregate to Value Objects
    AdmissionAgg -->|uses| PatientIdentity
    AdmissionAgg -->|uses| BedLocation
    UserSession -->|uses| PinCredential
    ProvisioningSession -->|uses| CredentialBundle

    %% Inbound (from UI)
    InterfaceModule -.->|Qt::QueuedConnection<br/>User actions| AdmissionService
    InterfaceModule -.->|Qt::QueuedConnection<br/>User actions| ProvisioningService
    InterfaceModule -.->|Qt::QueuedConnection<br/>Login/logout| SecurityService

    %% Outbound (to UI)
    AdmissionService -.->|Qt::QueuedConnection<br/>Domain events| InterfaceModule
    ProvisioningService -.->|Qt::QueuedConnection<br/>Domain events| InterfaceModule
    SecurityService -.->|Qt::QueuedConnection<br/>Domain events| InterfaceModule

    %% Outbound (to Database)
    AdmissionService -.->|MPSC Queue<br/>Repository calls| DatabaseModule
    ProvisioningService -.->|MPSC Queue<br/>Repository calls| DatabaseModule
    SecurityService -.->|MPSC Queue<br/>Repository calls| DatabaseModule

    %% Outbound (to Network)
    AdmissionService -.->|Qt::QueuedConnection<br/>Patient lookup| NetworkModule
    SecurityService -.->|Qt::QueuedConnection<br/>User auth| NetworkModule

    %% Styling
    classDef service fill:#c8e6c9,stroke:#388e3c,stroke-width:2px
    classDef aggregate fill:#d1c4e9,stroke:#512da8,stroke-width:2px
    classDef value fill:#e1f5ff,stroke:#0288d1,stroke-width:2px
    classDef external fill:#f5f5f5,stroke:#757575,stroke-width:2px,stroke-dasharray: 5 5

    class Services,AdmissionService,ProvisioningService,SecurityService,PermissionRegistry service
    class Aggregates,AdmissionAgg,ProvisioningSession,UserSession,AuditTrail aggregate
    class ValueObjects,PatientIdentity,BedLocation,PinCredential,CredentialBundle value
    class ExternalModules,InterfaceModule,DatabaseModule,NetworkModule external

