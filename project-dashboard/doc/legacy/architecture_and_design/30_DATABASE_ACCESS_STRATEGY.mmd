graph TB
    subgraph "Application Layer"
        MonitoringService[MonitoringService]
        AdmissionService[AdmissionService]
        ProvisioningService[ProvisioningService]
        SecurityService[SecurityService]
    end

    subgraph "Domain Layer - Repository Interfaces"
        IPatientRepo[IPatientRepository]
        ITelemetryRepo[ITelemetryRepository]
        IAlarmRepo[IAlarmRepository]
        IProvisioningRepo[IProvisioningRepository]
        IUserRepo[IUserRepository]
        IAuditRepo[IAuditRepository]
    end

    subgraph "Schema Management - Single Source of Truth"
        SchemaYAML[database.yaml<br/>━━━━━━━━━━━━━━━━<br/>Tables, Columns<br/>Indices, Constraints<br/>Retention Policies<br/>━━━━━━━━━━━━━━━━<br/>⭐ Single Source]
        SchemaGen[generate_schema.py<br/>Code Generator]
        SchemaH[SchemaInfo.h<br/>━━━━━━━━━━━━━━━━<br/>Schema::Tables::<br/>• PATIENTS<br/>• VITALS<br/>━━━━━━━━━━━━━━━━<br/>Schema::Columns::<br/>• Patients::MRN<br/>• Vitals::TIMESTAMP<br/>━━━━━━━━━━━━━━━━<br/>✅ Type-Safe Constants]
    end

    subgraph "Infrastructure Layer - Repository Implementations"
        SQLitePatientRepo[SQLitePatientRepository<br/>━━━━━━━━━━━━━━━━<br/>Option 1: QxOrm<br/>  qx::dao::fetch_by_id<br/>  Uses Schema Constants<br/>━━━━━━━━━━━━━━━━<br/>Option 2: Manual Qt SQL<br/>  QSqlQuery + QueryRegistry<br/>  Uses Schema Constants]
        SQLiteTelemetryRepo[SQLiteTelemetryRepository<br/>━━━━━━━━━━━━━━━━<br/>Manual Qt SQL<br/>Batch INSERT<br/>Time-Series Queries<br/>Uses Schema Constants]
        SQLiteAlarmRepo[SQLiteAlarmRepository]
        SQLiteProvisioningRepo[SQLiteProvisioningRepository]
        SQLiteUserRepo[SQLiteUserRepository]
        SQLiteAuditRepo[SQLiteAuditRepository]
    end

    subgraph "ORM Layer Optional QxOrm"
        OrmPatient[PatientAggregateMapping<br/>━━━━━━━━━━━━━━━━<br/>QxOrm Registration:<br/>t.setNameTables::PATIENTS<br/>t.idmrn, Columns::Patients::MRN<br/>t.dataname, Columns::Patients::NAME<br/>━━━━━━━━━━━━━━━━<br/>✅ Uses Schema Constants]
        OrmVital[VitalRecordMapping<br/>Similar pattern]
    end

    subgraph "Infrastructure Layer - Database Manager"
        DBManager[DatabaseManager<br/>━━━━━━━━━━━━━━━━<br/>Connection Management:<br/>• Write Connection DB Thread<br/>• Read Connection any thread<br/>━━━━━━━━━━━━━━━━<br/>Prepared Statement Cache:<br/>• Pre-compiled queries<br/>• Reused for performance<br/>━━━━━━━━━━━━━━━━<br/>Transaction Management<br/>Migration Runner<br/>SQLCipher Encryption]
    end

    subgraph "Database - SQLite + SQLCipher"
        DB[(SQLite Database<br/>━━━━━━━━━━━━━━━━<br/>WAL Mode Enabled<br/>Encrypted with SQLCipher<br/>━━━━━━━━━━━━━━━━<br/>Tables:<br/>• patients<br/>• vitals<br/>• alarms<br/>• telemetry_metrics<br/>• certificates<br/>• security_audit_log<br/>• ...)]
    end
    
    %% Schema workflow
    SchemaYAML -->|generates| SchemaGen
    SchemaGen -->|produces| SchemaH

    %% Application Services depend on Repository Interfaces
    MonitoringService --> IPatientRepo
    MonitoringService --> ITelemetryRepo
    MonitoringService --> IAlarmRepo
    AdmissionService --> IPatientRepo
    AdmissionService --> IAuditRepo
    ProvisioningService --> IProvisioningRepo
    SecurityService --> IUserRepo
    SecurityService --> IAuditRepo

    %% Repository Interfaces implemented by Infrastructure
    IPatientRepo -.implements.-> SQLitePatientRepo
    ITelemetryRepo -.implements.-> SQLiteTelemetryRepo
    IAlarmRepo -.implements.-> SQLiteAlarmRepo
    IProvisioningRepo -.implements.-> SQLiteProvisioningRepo
    IUserRepo -.implements.-> SQLiteUserRepo
    IAuditRepo -.implements.-> SQLiteAuditRepo

    %% Schema constants used by repositories and ORM
    SchemaH -->|"includes<br/>type-safe constants"| SQLitePatientRepo
    SchemaH -->|"includes<br/>type-safe constants"| SQLiteTelemetryRepo
    SchemaH -->|"includes<br/>type-safe constants"| OrmPatient
    SchemaH -->|"includes<br/>type-safe constants"| OrmVital

    %% ORM used by repositories (optional)
    OrmPatient -.optional.-> SQLitePatientRepo
    OrmVital -.optional.-> SQLiteTelemetryRepo

    %% All Repository Implementations use DatabaseManager
    SQLitePatientRepo --> DBManager
    SQLiteTelemetryRepo --> DBManager
    SQLiteAlarmRepo --> DBManager
    SQLiteProvisioningRepo --> DBManager
    SQLiteUserRepo --> DBManager
    SQLiteAuditRepo --> DBManager

    %% DatabaseManager accesses SQLite
    DBManager --> DB
    
    %% Schema generates DDL for database
    SchemaGen -.generates DDL.-> DB

    %% Styling
    classDef appService fill:#c8e6c9,stroke:#388e3c,stroke-width:2px
    classDef repoInterface fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    classDef repoImpl fill:#ffccbc,stroke:#d84315,stroke-width:2px
    classDef dbManager fill:#d1c4e9,stroke:#512da8,stroke-width:3px
    classDef database fill:#b0bec5,stroke:#37474f,stroke-width:3px
    classDef schema fill:#fff3e0,stroke:#e65100,stroke-width:3px
    classDef orm fill:#e8eaf6,stroke:#3f51b5,stroke-width:2px

    class MonitoringService,AdmissionService,ProvisioningService,SecurityService appService
    class IPatientRepo,ITelemetryRepo,IAlarmRepo,IProvisioningRepo,IUserRepo,IAuditRepo repoInterface
    class SQLitePatientRepo,SQLiteTelemetryRepo,SQLiteAlarmRepo,SQLiteProvisioningRepo,SQLiteUserRepo,SQLiteAuditRepo repoImpl
    class DBManager dbManager
    class DB database
    class SchemaYAML,SchemaGen,SchemaH schema
    class OrmPatient,OrmVital orm

