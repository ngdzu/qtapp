name: Generate API Documentation

on:
  # Run on schedule (nightly at 2 AM UTC)
  schedule:
    - cron: '0 2 * * *'
  # Run on push to main/master branch
  push:
    branches:
      - main
      - master
    paths:
      - 'project-dashboard/src/**'
      - 'project-dashboard/Doxyfile'
      - 'project-dashboard/CMakeLists.txt'
  # Run on pull requests (optional - can be disabled if too slow)
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'project-dashboard/src/**'
      - 'project-dashboard/Doxyfile'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  generate-docs:
    name: Generate Doxygen Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better documentation

      - name: Install Doxygen and Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz

      - name: Verify Doxygen installation
        run: |
          doxygen --version
          dot -V

      - name: Generate API Documentation
        working-directory: project-dashboard
        run: |
          # Create output directory
          mkdir -p docs/api
          
          # Generate documentation
          doxygen Doxyfile || true
          
          # Check if documentation was generated
          if [ ! -d "docs/api/html" ]; then
            echo "‚ö†Ô∏è  Warning: Documentation generation may have failed"
            exit 1
          fi
          
          echo "‚úì Documentation generated successfully"

      - name: Check Documentation Coverage
        working-directory: project-dashboard
        run: |
          # Count undocumented items from Doxygen warnings
          if [ -f "docs/api/doxygen_warnings.log" ]; then
            UNDOCUMENTED=$(grep -c "is not documented" docs/api/doxygen_warnings.log || echo "0")
            echo "Undocumented items: $UNDOCUMENTED"
            
            # Fail if too many undocumented items (threshold: 10)
            if [ "$UNDOCUMENTED" -gt 10 ]; then
              echo "‚ùå Too many undocumented items ($UNDOCUMENTED). Please add Doxygen comments."
              echo "See .cursor/rules/api_documentation.mdc for documentation requirements"
              exit 1
            fi
          fi
          
      - name: Validate Documentation Quality
        working-directory: project-dashboard
        run: |
          # Check for missing @param tags in warnings
          if [ -f "docs/api/doxygen_warnings.log" ]; then
            MISSING_PARAM=$(grep -c "The following parameter.*is not documented" docs/api/doxygen_warnings.log || echo "0")
            MISSING_RETURN=$(grep -c "return value.*not documented" docs/api/doxygen_warnings.log || echo "0")
            
            echo "Missing @param tags: $MISSING_PARAM"
            echo "Missing @return tags: $MISSING_RETURN"
            
            # Warn if parameters or return values are missing (non-blocking for now)
            if [ "$MISSING_PARAM" -gt 0 ] || [ "$MISSING_RETURN" -gt 0 ]; then
              echo "‚ö†Ô∏è  Warning: Some parameters or return values are not documented."
              echo "Please ensure all public methods have @param and @return tags."
              echo "See doc/z-monitor/architecture_and_design/26_API_DOCUMENTATION.md for requirements"
              # Don't fail build, but warn (can be made stricter later)
            fi
          fi
          
      - name: Generate Documentation Quality Report
        working-directory: project-dashboard
        run: |
          # Generate a summary report of documentation quality
          if [ -f "docs/api/doxygen_warnings.log" ]; then
            echo "## Documentation Quality Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Undocumented Items" >> $GITHUB_STEP_SUMMARY
            UNDOCUMENTED=$(grep -c "is not documented" docs/api/doxygen_warnings.log || echo "0")
            echo "- Total undocumented: $UNDOCUMENTED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Missing Documentation Tags" >> $GITHUB_STEP_SUMMARY
            MISSING_PARAM=$(grep -c "The following parameter.*is not documented" docs/api/doxygen_warnings.log || echo "0")
            MISSING_RETURN=$(grep -c "return value.*not documented" docs/api/doxygen_warnings.log || echo "0")
            echo "- Missing @param tags: $MISSING_PARAM" >> $GITHUB_STEP_SUMMARY
            echo "- Missing @return tags: $MISSING_RETURN" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Code Review Checklist" >> $GITHUB_STEP_SUMMARY
            echo "Please verify manually:" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] All new public classes have Doxygen class comments" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] All new public methods have @param and @return tags" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] Exceptions/errors documented" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] Examples provided for complex APIs" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] Cross-references (@see) included" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] File headers present" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] Performance notes (@performance tag) where applicable" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] Thread assignment (@thread tag) where applicable" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See [26_API_DOCUMENTATION.md](doc/z-monitor/architecture_and_design/26_API_DOCUMENTATION.md) for complete requirements." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Documentation Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: api-documentation
          path: project-dashboard/docs/api/html
          retention-days: 30

      - name: Comment PR with Documentation Status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Check if documentation was generated
            const docsPath = 'project-dashboard/docs/api/html';
            let undocumentedCount = 0;
            let missingParamCount = 0;
            let missingReturnCount = 0;
            
            // Parse warnings log if it exists
            const warningsPath = 'project-dashboard/docs/api/doxygen_warnings.log';
            if (fs.existsSync(warningsPath)) {
              const warnings = fs.readFileSync(warningsPath, 'utf8');
              const undocumentedMatches = warnings.match(/is not documented/g);
              const paramMatches = warnings.match(/The following parameter.*is not documented/g);
              const returnMatches = warnings.match(/return value.*not documented/g);
              
              undocumentedCount = undocumentedMatches ? undocumentedMatches.length : 0;
              missingParamCount = paramMatches ? paramMatches.length : 0;
              missingReturnCount = returnMatches ? returnMatches.length : 0;
            }
            
            if (fs.existsSync(docsPath)) {
              const files = fs.readdirSync(docsPath);
              let commentBody = `‚úÖ API documentation generated successfully.\n\n`;
              commentBody += `üìö Documentation includes ${files.length} files.\n\n`;
              
              if (undocumentedCount > 0 || missingParamCount > 0 || missingReturnCount > 0) {
                commentBody += `‚ö†Ô∏è  Documentation Quality Issues:\n`;
                commentBody += `- Undocumented items: ${undocumentedCount}\n`;
                commentBody += `- Missing @param tags: ${missingParamCount}\n`;
                commentBody += `- Missing @return tags: ${missingReturnCount}\n\n`;
                commentBody += `Please review the [documentation checklist](doc/z-monitor/architecture_and_design/26_API_DOCUMENTATION.md#232-code-review-checklist) and add missing documentation.\n\n`;
              }
              
              commentBody += `Download the documentation artifact to view locally.`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            } else {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `‚ö†Ô∏è  API documentation generation completed with warnings.\n\n` +
                      `Check the workflow logs for details.\n\n` +
                      `See [documentation requirements](doc/z-monitor/architecture_and_design/26_API_DOCUMENTATION.md) for guidelines.`
              });
            }

      # Optional: Deploy to GitHub Pages (uncomment if desired)
      # - name: Deploy to GitHub Pages
      #   if: github.ref == 'refs/heads/main'
      #   uses: peaceiris/actions-gh-pages@v3
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     publish_dir: project-dashboard/docs/api/html

